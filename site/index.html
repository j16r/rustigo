<!doctype html>

<html lang="en" style="height: 100%">
  <head>
    <meta charset="utf-8">

    <title>Go</title>
    <meta name="description" content="Go">
    <style>
span.black::before {
  top: 0;
  left: 0;
  content: "";
  position: absolute;
  background-image: url("images/blackpiece.png");
  width: 100%;
  height: 100%;
  z-index: 1;
}

span.white::before {
  top: 0;
  left: 0;
  content: "";
  position: absolute;
  background-image: url("images/whitepiece.png");
  width: 100%;
  height: 100%;
  z-index: 1;
}
    </style>
    <script>
let uri = window.location;
let new_uri;
if (uri.protocol === "https:") {
  new_uri = "wss:";
} else {
  new_uri = "ws:";
}
new_uri += "//" + uri.hostname + ":3012";
new_uri += uri.pathname + "/ws";

let socket = new WebSocket(new_uri);
socket.onmessage = function(event) {
  console.log(event.data);
}

window.onload = function() {
  let hash = document.location.hash;
  if(hash !== '') {
    drawBoard(hash.substring(1));
  } else {
    document.getElementById('menu').style.cssText = 'display: block';
  }
};

let getElementByXPath = function(query) {
  console.log(query);
  return document.evaluate(query, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
}

let drawBoard = function(size) {
  let player = 'white';

  let getTile = function(x, y) {
    return getElementByXPath('//div[position()=' + (y + 1) + ']/span[position()=' + (x + 1) + ']');
  }

  let placeTile = function(x, y) {
    console.log('placing tile at', x, y);
    let tile = getTile(x, y);
    if(tile !== null) {
      console.log('tile', tile);
      tile.classList.add(player);
      if(player === 'white') {
        player = 'black';
      } else {
        player = 'white';
      }
    }
  }

  let menu = document.getElementById('menu');
  menu.style.cssText = 'display: none';
  document.getElementById('game').style.cssText = 'display: block';

  const pieceSize = 80.0 / size;

  let board = document.getElementById('board');
  for(let y = 0; y < size; y++) {
    let row = board.appendChild(document.createElement('div'));
    row.style.cssText = 'height: ' + pieceSize + 'vmin; display: block';
    for(let x = 0; x < size; x++) {
      let tile = document.createElement('span');
      tile.style.cssText = 'display: inline-block; height: ' + 
        pieceSize + 'vmin; width: ' + 
        pieceSize + 'vmin; background-size: ' +
        pieceSize + 'vmin; background-image: url("images/tilecenter.png");' +
        'position: relative; z-index: 1;';
      tile.onclick = function() {
        placeTile(x, y);
      }
      row.appendChild(tile);
    }
  }
};

let beginGame = function() {
  let checked = document.querySelector('input[name=size]:checked');
  if(checked) {
    document.location.hash = checked.value;
    drawBoard(checked.value);
  }
};
    </script>
  </head>

  <body style="height: 100%; margin: 0">

    <section style="display: flex; align-items: center; justify-content: center; height: 100%; padding: 0; margin: 0">
      <form id="menu" style="display: none">
        <input type="radio" name="size" value="9">9x9</input>
        <input type="radio" name="size" value="13">13x13</input>
        <input type="radio" name="size" value="17">17x17</input>
        <input type="radio" name="size" value="19">19x19</input>
        <input type="button" value="Begin game" onclick="beginGame();" keydown="beginGame();">
      </form>

      <div id="game" style="display: none;">
        <section id="board" style="height: 100%;">
        </section>
      </section>
    </section>

  </body>
</html>
